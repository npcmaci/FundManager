"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fsExtra = require("fs-extra");

var _path = _interopRequireDefault(require("path"));

var _app = _interopRequireDefault(require("./app"));

var _frame = _interopRequireDefault(require("./frame"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function huiPluginMicroApp(api, options = {}) {
  api.chainWebpack(webpackConfig => {
    webpackConfig.module.rule('js').include.add(_path.default.resolve(__dirname, 'src', 'lib')).end();
  });

  if (process.env.HUI_BUILD_TARGET === 'app') {
    if (options.type === 'app') {
      return (0, _app.default)(api, options);
    }

    if (options.type === 'frame') {
      return (0, _frame.default)(api, options);
    }
  }

  if (process.env.HUI_BUILD_TARGET === 'module') {
    api.service.modules.forEach(key => {
      (0, _fsExtra.outputFileSync)(api.resolve(`src/modules/${key}/.hui/setModulePublicPath.js`), `if (window.__POWERED_BY_HUI_MICRO_APP__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_HUI_MICRO_APP__;
}
      `);
      api.addEntryFileAhead(`${key}/${key}`, `@/modules/${key}/.hui/setModulePublicPath.js`);
    });
    return;
  }
}

var _default = huiPluginMicroApp; // maintain compatibility with older service

exports.default = _default;
module.exports = huiPluginMicroApp;